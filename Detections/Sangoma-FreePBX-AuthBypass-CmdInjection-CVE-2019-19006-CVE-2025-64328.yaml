id: 6ee615b5-493b-4d93-a70a-bd8c9a6daf73
name: Sangoma FreePBX Authentication Bypass and Command Injection (CVE-2019-19006 / CVE-2025-64328)
description: |
  Detects exploitation of two Sangoma FreePBX vulnerabilities that are commonly chained
  together in attacks against internet-exposed VoIP/PBX infrastructure:

  CVE-2019-19006 — Improper Authentication (added to CISA KEV 2026-02-03):
    FreePBX admin panel authentication bypass allows unauthorized users to bypass password
    authentication and access administrative services. Affects FreePBX ≤ 13 (Sangoma-branded).

  CVE-2025-64328 — OS Command Injection (added to CISA KEV 2026-02-03):
    Sangoma FreePBX Endpoint Manager contains a post-authentication OS command injection
    vulnerability in the check_ssh_connect() function called via the testconnection endpoint.
    An authenticated attacker (or one who bypassed auth via CVE-2019-19006) can inject
    arbitrary OS commands and obtain remote access as the 'asterisk' system user.

  FreePBX is widely deployed in SMB and enterprise telephony environments. Compromise enables
  toll fraud, call interception, credential harvesting, and lateral movement.

  Detection focuses on:
  - Access to FreePBX admin panel from external/unusual IPs without prior session indicators
  - HTTP requests to the Endpoint Manager testconnection endpoint with injection payloads
  - Processes spawned as the 'asterisk' system user (FreePBX runtime account)
  - Outbound connections from Asterisk/FreePBX processes to attacker infrastructure

  References:
    - https://github.com/FreePBX/security-reporting/security/advisories/GHSA-vm9p-46mv-5xvw
    - https://wiki.freepbx.org/display/FOP/2019-11-20+Remote+Admin+Authentication+Bypass
    - https://nvd.nist.gov/vuln/detail/CVE-2025-64328
    - https://nvd.nist.gov/vuln/detail/CVE-2019-19006
    - https://www.cisa.gov/known-exploited-vulnerabilities-catalog

severity: High
status: Available
requiredDataConnectors:
  - connectorId: CEF
    datatypes:
      - CommonSecurityLog
  - connectorId: MicrosoftDefenderForEndpoint
    datatypes:
      - DeviceProcessEvents
      - DeviceNetworkEvents
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
  - Execution
relevantTechniques:
  - T1190
  - T1059
query: |
  // -----------------------------------------------------------------------
  // Query 1: CVE-2019-19006 — Auth bypass: admin panel access from external IPs
  // Flag requests to FreePBX admin paths without session indicators, or with
  // auth bypass patterns in the request (direct object references, etc.)
  // -----------------------------------------------------------------------
  let FreePBX_AuthBypass = union isfuzzy=true (
    CommonSecurityLog
    | where TimeGenerated > ago(1h)
    | where RequestURL has_any (
        "/admin/", "/admin/config.php", "/admin/modules/",
        "/recordings/", "/user_portal/",
        "/admin/ajax.php", "/admin/libraries/"
      )
    | where RequestMethod in ("GET", "POST")
    // External source IPs only (flag unexpected admin access)
    | where not(ipv4_is_private(SourceIP))
    // Auth bypass indicators: missing session cookies, direct parameter-based access
    | extend ResponseCode = tostring(EventOutcome)
    | extend AlertDetail = strcat(
        "FreePBX admin accessed from external IP ", SourceIP,
        ": ", RequestMethod, " ", RequestURL, " (HTTP ", ResponseCode, ")"
      )
    | project TimeGenerated, SourceIP, DestinationIP, RequestURL,
              RequestMethod, ResponseCode, AlertDetail
  );
  // -----------------------------------------------------------------------
  // Query 2: CVE-2025-64328 — Command injection via testconnection endpoint
  // The vulnerable function is check_ssh_connect() triggered via:
  //   POST /admin/ajax.php  with type=module&module=endpointman&action=testconnection
  // Injection in SSH host/port parameters (shell metacharacters: ;|`$()&)
  // -----------------------------------------------------------------------
  let FreePBX_CmdInjection = union isfuzzy=true (
    CommonSecurityLog
    | where TimeGenerated > ago(1h)
    | where RequestURL has_any (
        "/admin/ajax.php",
        "/admin/config.php"
      )
    | where RequestMethod == "POST"
    | where AdditionalExtensions has_any (
        "endpointman", "testconnection", "check_ssh"
      )
      or RequestURL has_any (
        "endpointman", "testconnection"
      )
    // Shell injection metacharacters in request parameters
    | where AdditionalExtensions matches regex @"[;|`\$\(\)&]"
        or RequestURL matches regex @"[;|`\$\(\)&]"
    | extend ResponseCode = tostring(EventOutcome)
    | extend AlertDetail = strcat(
        "FreePBX Endpoint Manager command injection attempt from ", SourceIP,
        " to ", RequestURL, " — possible CVE-2025-64328"
      )
    | project TimeGenerated, SourceIP, DestinationIP, RequestURL,
              RequestMethod, ResponseCode, AlertDetail
  );
  // -----------------------------------------------------------------------
  // Query 3: Suspicious processes launched as 'asterisk' (FreePBX runtime user)
  // Successful command injection results in commands running as the asterisk user.
  // -----------------------------------------------------------------------
  let FreePBX_AsteriskExec = DeviceProcessEvents
    | where TimeGenerated > ago(1h)
    | where AccountName has_any ("asterisk", "freepbx")
    | where FileName has_any (
        "bash", "sh", "dash", "zsh",
        "wget", "curl", "python", "python3", "perl", "ruby",
        "nc", "ncat", "netcat",
        "chmod", "chown",
        "id", "whoami", "uname"
      )
    | where InitiatingProcessFileName has_any (
        "php", "php-fpm", "httpd", "apache2", "nginx"
      )
    | extend AlertDetail = strcat(
        "FreePBX: 'asterisk' user spawned ", FileName,
        " via web server on ", DeviceName,
        " — possible RCE via CVE-2025-64328"
      )
    | project TimeGenerated, DeviceName, AccountName, InitiatingProcessFileName,
              FileName, ProcessCommandLine, AlertDetail;
  // -----------------------------------------------------------------------
  // Query 4: Outbound connections from Asterisk process
  // Post-exploitation C2 callback from asterisk/FreePBX process.
  // -----------------------------------------------------------------------
  let FreePBX_C2Callback = DeviceNetworkEvents
    | where TimeGenerated > ago(1h)
    | where InitiatingProcessFileName has_any (
        "asterisk", "php", "php-fpm"
      )
    | where InitiatingProcessAccountName has_any ("asterisk", "freepbx")
    | where RemoteIPType !in ("Private", "Loopback")
    | where RemotePort !in (5060, 5061, 4569, 80, 443)  // Exclude standard VoIP/web ports
    | extend AccountName = InitiatingProcessAccountName
    | extend AlertDetail = strcat(
        "FreePBX asterisk process unexpected outbound to ",
        RemoteIP, ":", RemotePort, " on ", DeviceName
      )
    | project TimeGenerated, DeviceName, AccountName, InitiatingProcessFileName,
              RemoteIP, RemotePort, RemoteUrl, AlertDetail;
  // Combine all sub-queries
  union FreePBX_AuthBypass, FreePBX_CmdInjection, FreePBX_AsteriskExec, FreePBX_C2Callback
  | sort by TimeGenerated desc

entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: DeviceName
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SourceIP
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: RemoteIP
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: AccountName

customDetails:
  AlertDetail: AlertDetail

alertDetailsOverride:
  alertDisplayNameFormat: "FreePBX CVE-2019-19006/CVE-2025-64328 Indicator: {{AlertDetail}}"
  alertDescriptionFormat: "Possible exploitation of Sangoma FreePBX authentication bypass (CVE-2019-19006) or command injection (CVE-2025-64328). {{AlertDetail}}"

suppressionDuration: 4h
suppressionEnabled: false
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: 4h
    matchingMethod: AllEntities
    groupByEntities:
      - Host
      - IP
    groupByAlertDetails: []
    groupByCustomDetails: []

version: 1.0.0
kind: Scheduled
