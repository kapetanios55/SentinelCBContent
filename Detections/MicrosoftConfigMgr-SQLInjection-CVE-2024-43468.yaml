id: f1a2b3c4-d5e6-7890-abcd-ef1234567903
name: Microsoft Configuration Manager SQL Injection Exploitation (CVE-2024-43468)
description: |
  Detects potential exploitation of CVE-2024-43468, an unauthenticated SQL injection
  vulnerability in Microsoft Configuration Manager (MECM/SCCM). An attacker can send
  specially crafted HTTP requests to the ConfigMgr management point to inject SQL commands,
  enabling arbitrary command execution on the site server and underlying SQL Server instance.

  Exploitation indicators include:
  - SQL Server (sqlservr.exe) spawning unexpected child processes (cmd, powershell, etc.)
  - CCMExec or SMS Agent Host spawning shell processes
  - Unusual outbound network connections from SCCM/MECM server processes
  - Suspicious web requests to ConfigMgr management point endpoints

  CVE-2024-43468 was added to the CISA KEV catalog on 2026-02-12. CVSS score: 9.8 (Critical).
  There is no authentication required to exploit this vulnerability.

  References:
    - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-43468
    - https://nvd.nist.gov/vuln/detail/CVE-2024-43468
    - https://www.cisa.gov/known-exploited-vulnerabilities-catalog

severity: High
status: Available
requiredDataConnectors:
  - connectorId: MicrosoftDefenderForEndpoint
    datatypes:
      - DeviceProcessEvents
      - DeviceNetworkEvents
  - connectorId: CEF
    datatypes:
      - CommonSecurityLog
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
  - Execution
  - LateralMovement
relevantTechniques:
  - T1190
  - T1059
  - T1210
query: |
  // -----------------------------------------------------------------------
  // Query 1: SQL Server spawning unexpected child processes
  // CVE-2024-43468 can cause sqlservr.exe to execute OS commands via xp_cmdshell
  // or similar SQL injection payloads
  // -----------------------------------------------------------------------
  let ConfigMgrSQLProcs = DeviceProcessEvents
    | where TimeGenerated > ago(1h)
    | where InitiatingProcessFileName =~ "sqlservr.exe"
    | where FileName has_any (
        "cmd.exe", "powershell.exe", "pwsh.exe", "wscript.exe", "cscript.exe",
        "mshta.exe", "rundll32.exe", "regsvr32.exe", "certutil.exe",
        "bitsadmin.exe", "curl.exe", "wget.exe", "nc.exe", "ncat.exe"
      )
    | extend AlertDetail = strcat("sqlservr.exe spawned suspicious child process: ", FileName,
        " â€” possible CVE-2024-43468 SQL injection exploit")
    | project TimeGenerated, DeviceName, AccountName, InitiatingProcessFileName,
              FileName, ProcessCommandLine, AlertDetail;
  // -----------------------------------------------------------------------
  // Query 2: CCMExec / SMS Agent Host spawning shell processes
  // ConfigMgr client agent being abused to execute commands post-exploitation
  // -----------------------------------------------------------------------
  let CCMExecChildProcs = DeviceProcessEvents
    | where TimeGenerated > ago(1h)
    | where InitiatingProcessFileName has_any ("ccmexec.exe", "smsagent.exe", "ccmsetup.exe")
    | where FileName has_any (
        "cmd.exe", "powershell.exe", "pwsh.exe", "wscript.exe", "cscript.exe",
        "mshta.exe", "rundll32.exe", "certutil.exe", "net.exe", "net1.exe",
        "whoami.exe", "ipconfig.exe", "nltest.exe", "dsquery.exe"
      )
    | extend AlertDetail = strcat("ConfigMgr agent '", InitiatingProcessFileName,
        "' spawned suspicious process: ", FileName)
    | project TimeGenerated, DeviceName, AccountName, InitiatingProcessFileName,
              FileName, ProcessCommandLine, AlertDetail;
  // -----------------------------------------------------------------------
  // Query 3: Unusual outbound connections from SCCM/SQL server processes
  // Post-exploitation C2 beacon or data exfiltration from server processes
  // -----------------------------------------------------------------------
  let ConfigMgrOutbound = DeviceNetworkEvents
    | where TimeGenerated > ago(1h)
    | where InitiatingProcessFileName has_any (
        "sqlservr.exe", "ccmexec.exe", "smsexec.exe", "sitecomp.exe"
      )
    | where ActionType == "ConnectionSuccess"
    | where RemoteIPType == "Public"
    | where RemotePort !in (80, 443, 1433, 4022)  // Exclude normal SQL/MECM ports
    | extend AccountName = InitiatingProcessAccountName
    | extend AlertDetail = strcat("ConfigMgr/SQL process '", InitiatingProcessFileName,
        "' made unexpected outbound connection to ", RemoteIP, ":", RemotePort)
    | project TimeGenerated, DeviceName, AccountName, InitiatingProcessFileName,
              RemoteIP, RemotePort, AlertDetail;
  // -----------------------------------------------------------------------
  // Query 4: Suspicious HTTP requests to MECM management point endpoints
  // SQL injection payloads in requests to /SMS_MP, /ccm_system, etc.
  // -----------------------------------------------------------------------
  let MECMWebAttack = union isfuzzy=true (
    CommonSecurityLog
    | where TimeGenerated > ago(1h)
    | where RequestURL has_any ("/SMS_MP", "/ccm_system", "/ccm_client", "/ManagementServer")
    | where RequestURL has_any (
        "'", "\"", "--", "xp_cmdshell", "exec(", "UNION SELECT",
        "0x", "char(", "CAST(", "CONVERT(",
        "%27", "%22", "%2D%2D"  // URL-encoded variants
      )
    | extend AlertDetail = "Possible SQL injection attempt against MECM management point"
    | project TimeGenerated, SourceIP, DestinationIP, RequestURL, RequestMethod, AlertDetail
  );
  // Union all sub-queries
  union ConfigMgrSQLProcs, CCMExecChildProcs, ConfigMgrOutbound, MECMWebAttack
  | sort by TimeGenerated desc

entityMappings:
  - entityType: Host
    fieldMappings:
      - identifier: FullName
        columnName: DeviceName
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: RemoteIP
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: AccountName

customDetails:
  AlertDetail: AlertDetail

alertDetailsOverride:
  alertDisplayNameFormat: "MECM CVE-2024-43468 Exploit Indicator: {{AlertDetail}}"
  alertDescriptionFormat: "Possible exploitation of Microsoft Configuration Manager SQL injection (CVE-2024-43468). {{AlertDetail}}"

suppressionDuration: 4h
suppressionEnabled: false
incidentConfiguration:
  createIncident: true
  groupingConfiguration:
    enabled: true
    reopenClosedIncident: false
    lookbackDuration: 4h
    matchingMethod: AllEntities
    groupByEntities:
      - Host
    groupByAlertDetails: []
    groupByCustomDetails: []

version: 1.0.0
kind: Scheduled
