id: c3d4e5f6-a7b8-9012-cdef-123456789012
name: GitLab Server-Side Request Forgery Exploitation (CVE-2021-22175)
description: |
  Detects exploitation of GitLab CVE-2021-22175, an SSRF vulnerability triggered when
  webhooks to internal networks are enabled. Added to CISA KEV on 2026-02-18.
  Attackers can force GitLab to send requests to internal resources including:
  - Cloud metadata services (169.254.169.254) for credential theft
  - Internal APIs and admin interfaces
  - Azure IMDS (100.100.100.200) for managed identity token theft
  This can lead to cloud account takeover, lateral movement, and credential access.
  References:
  - https://nvd.nist.gov/vuln/detail/CVE-2021-22175
  - https://about.gitlab.com/releases/2021/02/11/critical-security-release-gitlab-13-8-4-released/
  - https://www.cisa.gov/known-exploited-vulnerabilities-catalog
severity: High
status: Available
requiredDataConnectors:
  - connectorId: CEF
    datatypes:
      - CommonSecurityLog
  - connectorId: AzureFirewall
    datatypes:
      - AzureDiagnostics
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
  - Discovery
  - CredentialAccess
relevantTechniques:
  - T1190
  - T1580
  - T1552
query: |
  let timeframe = 1h;
  let imds_targets = dynamic(['169.254.169.254', 'metadata.google.internal', '100.100.100.200']);
  let gitlab_webhook_paths = dynamic(['/hooks', 'hooks/test', 'api/v4/projects']);
  // Outbound IMDS/metadata requests (SSRF callback indicator)
  CommonSecurityLog
  | where TimeGenerated >= ago(timeframe)
  | where DestinationIP has_any (imds_targets)
     or RequestURL has_any (imds_targets)
  | extend SSRFType = 'IMDS/Cloud Metadata Access'
  | project TimeGenerated, SourceIP, DestinationIP, RequestURL, SSRFType, DeviceVendor, DeviceProduct
  | union (
      // Inbound exploitation attempts to GitLab webhook endpoints
      CommonSecurityLog
      | where TimeGenerated >= ago(timeframe)
      | where RequestURL has_any (gitlab_webhook_paths)
      | where RequestMethod == 'POST'
      | where AdditionalExtensions has_any (imds_targets)
         or RequestURL has_any ('localhost', '127.0.0.1', '0.0.0.0', '169.254')
      | extend SSRFType = 'GitLab Webhook SSRF Payload'
      | project TimeGenerated, SourceIP, DestinationIP, RequestURL, SSRFType, DeviceVendor, DeviceProduct
  )
  | union (
      // Azure Firewall - Internal network access
      AzureDiagnostics
      | where TimeGenerated >= ago(timeframe)
      | where Category in ('AzureFirewallApplicationRule', 'AzureFirewallNetworkRule')
      | where dstIp_s has_any (imds_targets) or requestUrl_s has_any (imds_targets)
      | extend SSRFType = 'Azure Firewall - IMDS Access Attempt'
      | project TimeGenerated, SourceIP = srcIp_s, DestinationIP = dstIp_s, RequestURL = requestUrl_s, SSRFType, DeviceVendor = 'Azure', DeviceProduct = 'AzureFirewall'
  )
  | summarize FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated), Count = count(), URLs = make_set(RequestURL, 5)
      by SourceIP, DestinationIP, SSRFType
  | sort by Count desc
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SourceIP
version: 1.0.1
kind: Scheduled
