id: c2e85d47-3b6e-4f11-9a14-smarter24423
name: SmarterMail Missing Authentication RCE via ConnectToHub API (CVE-2026-24423)
description: |
  Detects exploitation of CVE-2026-24423, a missing authentication vulnerability in
  SmarterTools SmarterMail's ConnectToHub API method. An unauthenticated attacker can
  call this endpoint to redirect the SmarterMail server to connect to a malicious HTTP server,
  which then serves OS commands executed on the host. This vulnerability is associated with
  known ransomware campaigns (CISA KEV, added 2026-02-05).

  Detection logic covers:
  1. Suspicious process spawning from SmarterMail service processes.
  2. Unusual outbound HTTP connections from SmarterMail to non-standard destinations.
  3. CommonSecurityLog entries targeting the ConnectToHub API endpoint path.
  4. Syslog entries indicating SmarterMail service anomalies.

  References:
  - https://www.smartertools.com/smartermail/release-notes/current
  - https://nvd.nist.gov/vuln/detail/CVE-2026-24423

severity: High

requiredDataConnectors:
  - connectorId: MicrosoftDefenderAdvancedThreatProtection
    dataTypes:
      - DeviceProcessEvents
      - DeviceNetworkEvents
  - connectorId: CommonSecurityLog
    dataTypes:
      - CommonSecurityLog

queryFrequency: 1h
queryPeriod: 1h

triggerOperator: gt
triggerThreshold: 0

tactics:
  - InitialAccess
  - Execution
  - Persistence

relevantTechniques:
  - T1190
  - T1059
  - T1505

query: |
  let timeframe = 1h;
  let SmarterMailProcesses = dynamic([
      "SmarterMail.exe", "SmarterMail", "SmarterMailSvc.exe",
      "MailService.exe", "smtpd"
  ]);
  let SuspiciousChildren = dynamic([
      "cmd.exe", "powershell.exe", "powershell", "bash", "sh", "dash",
      "python", "python3", "perl", "ruby", "mshta.exe",
      "wscript.exe", "cscript.exe", "certutil.exe", "bitsadmin.exe",
      "net.exe", "net1.exe", "wget", "curl", "nc", "ncat", "netcat"
  ]);
  // Signal 1: Suspicious child process from SmarterMail service
  let ProcEvents = union isfuzzy=true (
      DeviceProcessEvents
      | where TimeGenerated >= ago(timeframe)
      | where InitiatingProcessFileName has_any (SmarterMailProcesses)
          or InitiatingProcessParentFileName has_any (SmarterMailProcesses)
      | where FileName has_any (SuspiciousChildren)
          or ProcessCommandLine has_any (
              "whoami", "net user", "net localgroup", "systeminfo",
              "ipconfig", "base64", "iex ", "invoke-expression",
              "downloadstring", "wget", "curl ", "chmod", "/bin/sh"
          )
      | extend AccountName = InitiatingProcessAccountName
      | extend Signal = "SuspiciousChildProcess"
      | project
          TimeGenerated,
          Signal,
          AccountName,
          DeviceName,
          FileName,
          ProcessCommandLine,
          InitiatingProcessFileName,
          InitiatingProcessCommandLine,
          SHA256
  );
  // Signal 2: SmarterMail connecting outbound to unexpected hosts
  // ConnectToHub exploit redirects mail server to attacker-controlled HTTP server
  let NetEvents = union isfuzzy=true (
      DeviceNetworkEvents
      | where TimeGenerated >= ago(timeframe)
      | where InitiatingProcessFileName has_any (SmarterMailProcesses)
      | where RemoteIPType !in ("Private", "Loopback", "LinkLocal")
      | where RemotePort !in (
          25, 465, 587, 993, 995, 143, 110, 2525,   // Standard mail ports
          443, 80                                     // Standard HTTPS/HTTP (review separately)
      )
      | extend AccountName = InitiatingProcessAccountName
      | extend Signal = "UnexpectedOutboundConnection"
      | project
          TimeGenerated,
          Signal,
          AccountName,
          DeviceName,
          RemoteIP,
          RemotePort,
          RemoteUrl,
          InitiatingProcessFileName,
          InitiatingProcessCommandLine
  );
  // Signal 3: Web/proxy logs showing ConnectToHub API requests
  let CSLEvents = union isfuzzy=true (
      CommonSecurityLog
      | where TimeGenerated >= ago(timeframe)
      | where DeviceVendor has_any ("SmarterTools", "SmarterMail")
          or RequestURL has_any (
              "ConnectToHub",
              "HubProtocol",
              "/services/hub",
              "/api/hub/connect",
              "/smarter/hub"
          )
      | extend AccountName = SourceUserName
      | extend Signal = "ConnectToHubAPIAccess"
      | project
          TimeGenerated,
          Signal,
          AccountName,
          DeviceName,
          SourceIP,
          RequestURL,
          EventOutcome,
          Message,
          RequestContext
  );
  // Union all signals
  union ProcEvents, NetEvents, CSLEvents
  | order by TimeGenerated desc

version: 1.0.0
kind: Scheduled
