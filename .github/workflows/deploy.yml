name: Deploy to Microsoft Sentinel

on:
  push:
    branches: [ main ]
    paths:
      - 'Detections/**'
      - 'Workbooks/**'
      - 'Hunting/**'

  workflow_dispatch:
    inputs:
      workspace_name:
        description: 'Sentinel workspace name (overrides secret)'
        required: false

jobs:
  deploy-analytic-rules:
    name: Deploy Analytic Rules to Sentinel
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Get changed detection files
        id: changed
        run: |
          git diff --name-only HEAD~1 HEAD -- 'Detections/*.yaml' > changed_files.txt || \
          find Detections -name '*.yaml' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Deploy analytic rules via az rest
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: |
          python3 << 'PYEOF'
          import os, yaml, json, subprocess, sys, re

          sub  = os.environ['AZURE_SUBSCRIPTION_ID']
          rg   = os.environ['AZURE_RESOURCE_GROUP']
          ws   = os.environ['SENTINEL_WORKSPACE']

          def to_iso8601(val):
              """Convert '1h', '5m', '1d' shorthand to ISO 8601 duration."""
              if str(val).startswith('PT') or str(val).startswith('P'):
                  return str(val)
              m = re.match(r'^(\d+)([mhd])$', str(val))
              if not m:
                  return str(val)
              n, unit = m.groups()
              return {'m': f'PT{n}M', 'h': f'PT{n}H', 'd': f'P{n}D'}[unit]

          def map_operator(op):
              mapping = {'gt': 'GreaterThan', 'lt': 'LessThan', 'eq': 'Equal',
                         'ne': 'NotEqual', 'gte': 'GreaterThanOrEqual', 'lte': 'LessThanOrEqual'}
              return mapping.get(str(op).lower(), op)

          try:
              with open('changed_files.txt') as f:
                  changed = [l.strip() for l in f if l.strip().endswith('.yaml')]
          except:
              changed = []

          if not changed:
              print("No detection files changed — nothing to deploy.")
              sys.exit(0)

          deployed, errors = 0, []

          for filepath in changed:
              if not os.path.exists(filepath):
                  print(f"  ⏭️  Deleted: {filepath}")
                  continue

              with open(filepath) as f:
                  rule = yaml.safe_load(f)

              rule_id   = rule.get('id', '')
              rule_name = rule.get('name', 'Unknown')
              print(f"\n→ Deploying: {rule_name}")

              body = {
                  'kind': 'Scheduled',
                  'properties': {
                      'displayName':        rule_name,
                      'description':        str(rule.get('description', '')).strip(),
                      'severity':           rule.get('severity', 'Medium'),
                      'enabled':            True,
                      'query':              str(rule.get('query', '')).strip(),
                      'queryFrequency':     to_iso8601(rule.get('queryFrequency', 'PT1H')),
                      'queryPeriod':        to_iso8601(rule.get('queryPeriod', 'PT1H')),
                      'triggerOperator':    map_operator(rule.get('triggerOperator', 'GreaterThan')),
                      'triggerThreshold':   int(rule.get('triggerThreshold', 0)),
                      'tactics':            rule.get('tactics', []),
                      'techniques':         rule.get('relevantTechniques', []),
                      'suppressionEnabled': False,
                      'suppressionDuration':'PT1H',
                  }
              }

              if 'entityMappings' in rule:
                  body['properties']['entityMappings'] = rule['entityMappings']

              url = (f"https://management.azure.com/subscriptions/{sub}/resourceGroups/{rg}"
                     f"/providers/Microsoft.OperationalInsights/workspaces/{ws}"
                     f"/providers/Microsoft.SecurityInsights/alertRules/{rule_id}"
                     f"?api-version=2023-02-01")

              result = subprocess.run(
                  ['az', 'rest', '--method', 'PUT', '--url', url, '--body', json.dumps(body)],
                  capture_output=True, text=True
              )

              if result.returncode == 0:
                  print(f"  ✅ Deployed: {rule_name}")
                  deployed += 1
              else:
                  err = result.stderr or result.stdout
                  print(f"  ❌ Failed: {rule_name}")
                  print(f"     {err[:300]}")
                  errors.append(rule_name)

          print(f"\n{'='*40}")
          print(f"Summary: {deployed} deployed, {len(errors)} failed")
          if errors:
              print(f"Failed rules: {errors}")
              sys.exit(1)
          PYEOF

  deploy-workbooks:
    name: Deploy Workbooks to Azure
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy workbooks via ARM
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        run: |
          FAILED=0
          for workbook in Workbooks/*.json; do
            NAME=$(basename "$workbook" .json)
            DEPLOY_NAME="${NAME:0:50}-$(date +%Y%m%d%H%M%S)"
            echo "→ Deploying: $workbook"
            if az deployment group create \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file "$workbook" \
              --name "$DEPLOY_NAME" \
              --output none; then
              echo "  ✅ Deployed: $NAME"
            else
              echo "  ❌ Failed: $NAME"
              FAILED=1
            fi
          done
          exit $FAILED
