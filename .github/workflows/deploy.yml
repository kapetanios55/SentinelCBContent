name: Deploy to Microsoft Sentinel

on:
  push:
    branches: [ main ]
    paths:
      - 'Detections/**'
      - 'Workbooks/**'
      - 'Hunting/**'

  workflow_dispatch:
    inputs:
      workspace_name:
        description: 'Sentinel workspace name (overrides secret)'
        required: false

jobs:
  deploy-analytic-rules:
    name: Deploy Analytic Rules to Sentinel
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Verify Azure access and Sentinel workspace
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: |
          echo "=== Auth Context ==="
          az account show --query "{subscription:id, name:name, tenantId:tenantId}" -o table

          echo "=== Resource Group ==="
          az group show --name "$AZURE_RESOURCE_GROUP" --query "{name:name, location:location}" -o table || \
            echo "❌ Resource group '$AZURE_RESOURCE_GROUP' not found or no access"

          echo "=== Sentinel Workspace ==="
          az monitor log-analytics workspace show \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --workspace-name "$SENTINEL_WORKSPACE" \
            --query "{name:name, sku:sku.name}" -o table || \
            echo "❌ Workspace '$SENTINEL_WORKSPACE' not found or no access"

          echo "=== Sentinel Alert Rules (first 3) ==="
          az rest \
            --method GET \
            --url "https://management.azure.com/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/$SENTINEL_WORKSPACE/providers/Microsoft.SecurityInsights/alertRules?api-version=2023-02-01&\$top=3" \
            --query "value[].properties.displayName" -o tsv || \
            echo "❌ Could not list alert rules — check Sentinel is enabled on this workspace"

      - name: Get changed detection files
        id: changed
        run: |
          git diff --name-only HEAD~1 HEAD -- 'Detections/*.yaml' > changed_files.txt || \
          find Detections -name '*.yaml' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Deploy analytic rules via az rest
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: python3 scripts/deploy-rules.py changed_files.txt

  deploy-workbooks:
    name: Deploy Workbooks to Azure
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy workbooks via ARM
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        run: |
          FAILED=0
          for workbook in Workbooks/*.json; do
            NAME=$(basename "$workbook" .json)
            DEPLOY_NAME="${NAME:0:50}-$(date +%Y%m%d%H%M%S)"
            echo "→ Deploying: $workbook"
            if az deployment group create \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file "$workbook" \
              --name "$DEPLOY_NAME" \
              --output none; then
              echo "  ✅ Deployed: $NAME"
            else
              echo "  ❌ Failed: $NAME"
              FAILED=1
            fi
          done
          exit $FAILED
