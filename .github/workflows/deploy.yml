name: Deploy to Microsoft Sentinel

on:
  push:
    branches: [ main ]
    paths:
      - 'Detections/**'
      - 'Workbooks/**'
      - 'Hunting/**'

  workflow_dispatch:
    inputs:
      workspace_name:
        description: 'Sentinel workspace name (overrides secret)'
        required: false

jobs:
  deploy-analytic-rules:
    name: Deploy Analytic Rules to Sentinel
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Verify Azure access and Sentinel workspace
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: |
          set -e

          echo "=== Auth Context ==="
          az account show --query "{subscription:id, name:name}" -o table

          echo "=== Verifying Resource Group: $AZURE_RESOURCE_GROUP ==="
          az group show --name "$AZURE_RESOURCE_GROUP" --query "name" -o tsv

          echo "=== Verifying Workspace: $SENTINEL_WORKSPACE ==="
          az monitor log-analytics workspace show \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --workspace-name "$SENTINEL_WORKSPACE" \
            --query "name" -o tsv

          echo "=== Verifying Sentinel is enabled ==="
          az rest \
            --method GET \
            --url "https://management.azure.com/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$AZURE_RESOURCE_GROUP/providers/Microsoft.OperationalInsights/workspaces/$SENTINEL_WORKSPACE/providers/Microsoft.SecurityInsights/alertRules?api-version=2023-02-01&\$top=1" \
            --query "value" -o tsv
          echo "✅ Sentinel is accessible"

      - name: Get changed detection files
        id: changed
        run: |
          git diff --name-only HEAD~1 HEAD -- 'Detections/*.yaml' > changed_files.txt || \
          find Detections -name '*.yaml' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Deploy analytic rules via az rest
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: |
          echo "=== Python version ==="
          python3 --version
          echo "=== yaml available ==="
          python3 -c "import yaml; print('yaml ok')"
          echo "=== changed_files.txt ==="
          cat changed_files.txt || echo "(empty or missing)"
          echo "=== running deploy script ==="
          python3 scripts/deploy-rules.py changed_files.txt

  deploy-hunting-queries:
    name: Deploy Hunting Queries to Sentinel
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get changed hunting files
        run: |
          git diff --name-only HEAD~1 HEAD -- 'Hunting/*.json' > changed_hunting.txt || \
          find Hunting -name '*.json' > changed_hunting.txt
          echo "Changed hunting files:"
          cat changed_hunting.txt

      - name: Deploy hunting queries via az rest
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: python3 scripts/deploy-hunting.py changed_hunting.txt

  deploy-workbooks:
    name: Deploy Workbooks to Azure
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy workbooks via ARM
        env:
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          SENTINEL_WORKSPACE: ${{ secrets.SENTINEL_WORKSPACE }}
        run: |
          FAILED=0
          for workbook in Workbooks/*.json; do
            NAME=$(basename "$workbook" .json)
            DEPLOY_NAME="${NAME:0:50}-$(date +%Y%m%d%H%M%S)"
            echo "→ Deploying: $workbook"
            if az deployment group create \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file "$workbook" \
              --name "$DEPLOY_NAME" \
              --parameters workbookWorkspaceName="$SENTINEL_WORKSPACE" \
              --output none; then
              echo "  ✅ Deployed: $NAME"
            else
              echo "  ❌ Failed: $NAME"
              FAILED=1
            fi
          done
          exit $FAILED
