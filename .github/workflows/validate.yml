name: Validate Sentinel Content

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-yaml:
    name: Validate YAML Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml jsonschema

      - name: Validate detection YAML files
        run: |
          python3 << 'EOF'
          import os, yaml, sys, uuid

          required_fields = ['id', 'name', 'description', 'severity', 'tactics', 'relevantTechniques', 'query', 'queryFrequency', 'queryPeriod', 'triggerOperator', 'triggerThreshold', 'version', 'kind']
          valid_severities = ['High', 'Medium', 'Low', 'Informational']
          errors = []

          for root, dirs, files in os.walk('Detections'):
              for f in files:
                  if not f.endswith('.yaml'):
                      continue
                  path = os.path.join(root, f)
                  with open(path) as fh:
                      try:
                          doc = yaml.safe_load(fh)
                      except yaml.YAMLError as e:
                          errors.append(f"{path}: YAML parse error: {e}")
                          continue
                  for field in required_fields:
                      if field not in doc:
                          errors.append(f"{path}: Missing required field '{field}'")
                  if 'severity' in doc and doc['severity'] not in valid_severities:
                      errors.append(f"{path}: Invalid severity '{doc['severity']}'")
                  if 'id' in doc:
                      try:
                          uuid.UUID(str(doc['id']))
                      except ValueError:
                          errors.append(f"{path}: 'id' is not a valid UUID")
                  print(f"  ✅ {path}")

          if errors:
              print("\n❌ Validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          else:
              print("\n✅ All detection files valid")
          EOF

      - name: Validate hunting query YAML files
        run: |
          python3 << 'EOF'
          import os, yaml, sys

          errors = []
          for root, dirs, files in os.walk('Hunting'):
              for f in files:
                  if not f.endswith('.yaml') and not f.endswith('.json'):
                      continue
                  path = os.path.join(root, f)
                  with open(path) as fh:
                      try:
                          if f.endswith('.yaml'):
                              doc = yaml.safe_load(fh)
                          else:
                              import json
                              doc = json.load(fh)
                      except Exception as e:
                          errors.append(f"{path}: Parse error: {e}")
                          continue
                  print(f"  ✅ {path}")

          if errors:
              for e in errors:
                  print(f"  ❌ {e}")
              sys.exit(1)
          EOF

  validate-arm-templates:
    name: Validate ARM Templates (Workbooks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ARM TTK (ARM Template Test Toolkit)
        run: |
          curl -sL https://aka.ms/arm-ttk-azuredevops -o arm-ttk.zip 2>/dev/null || true
          # Fallback: use az bicep / ARM schema validation via Python
          pip install jsonschema

      - name: Validate ARM template structure
        run: |
          python3 << 'EOF'
          import os, json, sys

          arm_required = ['$schema', 'contentVersion', 'resources']
          errors = []

          for root, dirs, files in os.walk('Workbooks'):
              for f in files:
                  if not f.endswith('.json'):
                      continue
                  path = os.path.join(root, f)
                  with open(path) as fh:
                      try:
                          doc = json.load(fh)
                      except json.JSONDecodeError as e:
                          errors.append(f"{path}: JSON parse error: {e}")
                          continue

                  for field in arm_required:
                      if field not in doc:
                          errors.append(f"{path}: Missing ARM field '{field}'")

                  # Check newGuid() is NOT used inline in resource names
                  resources = doc.get('resources', [])
                  for res in resources:
                      name = res.get('name', '')
                      if 'newGuid()' in name:
                          errors.append(f"{path}: Resource 'name' uses newGuid() inline — must be in parameter defaultValue instead")

                  # Check parameters section for proper newGuid() usage
                  params = doc.get('parameters', {})
                  for pname, pval in params.items():
                      default = str(pval.get('defaultValue', ''))
                      if 'newGuid()' in default:
                          print(f"  ℹ️  {path}: parameter '{pname}' uses newGuid() correctly in defaultValue")

                  print(f"  ✅ {path}")

          if errors:
              print("\n❌ ARM template validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          else:
              print("\n✅ All ARM templates valid")
          EOF

  check-duplicates:
    name: Check for Duplicate IDs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for duplicate detection IDs
        run: |
          python3 << 'EOF'
          import os, yaml
          ids = {}
          for root, dirs, files in os.walk('Detections'):
              for f in files:
                  if not f.endswith('.yaml'):
                      continue
                  path = os.path.join(root, f)
                  with open(path) as fh:
                      doc = yaml.safe_load(fh)
                  if 'id' in doc:
                      if doc['id'] in ids:
                          print(f"❌ Duplicate ID {doc['id']} in {path} and {ids[doc['id']]}")
                          exit(1)
                      ids[doc['id']] = path
          print(f"✅ All {len(ids)} detection IDs are unique")
          EOF
